package controller

import (
	"encoding/base64"
	"encoding/json"
	"github.com/gofiber/fiber/v2"
	"hunterbounter.com/web-panel/pkg/hunterbounter_json"
	"hunterbounter.com/web-panel/pkg/utils"
	"hunterbounter.com/web-panel/web/api/model"
	"log"
)

func VulnerabilityReportGET(c *fiber.Ctx) error {

	var zapReportList = model.GetZapReportList()

	var openvasReportList = model.GetOpenVasReportList()

	var fullJsonBase64 string

	var decodedAllData = make([]map[string]interface{}, 0)
	for _, record := range zapReportList {
		fullJsonBase64 = utils.GetString(record["full_json"])
		decodedData, err := base64.StdEncoding.DecodeString(fullJsonBase64)
		if err != nil {
			log.Println(err)
		}
		var decodedJson map[string]interface{}
		err = json.Unmarshal(decodedData, &decodedJson)
		if err != nil {
			log.Println(err)
		}
		decodedJson["db_id"] = record["id"]
		decodedJson["agent_type"] = "zap"
		decodedAllData = append(decodedAllData, decodedJson)

	}

	// zap ile openvas kayıtlarını birleştir
	var vulnerabilityRecords = make([]map[string]interface{}, 0)

	vulnerabilityRecords = append(vulnerabilityRecords, decodedAllData...)

	vulnerabilityRecords = append(vulnerabilityRecords, openvasReportList...)

	log.Println(len(vulnerabilityRecords))

	return RenderTemplate(c, "panel/vulnerability_report", fiber.Map{
		"Title":          "Vulnerability Report",
		"DecodedDataMap": vulnerabilityRecords,
	})

}

func ZapReportDetailGET(c *fiber.Ctx) error {

	id := c.Params("id")
	var vulnerabilityRecord = model.GetZapVulnerabilityById(id)

	fullJsonBase64 := utils.GetString(vulnerabilityRecord[0]["full_json"])
	decodedData, err := base64.StdEncoding.DecodeString(fullJsonBase64)

	var decodedJson map[string]interface{}
	err = json.Unmarshal(decodedData, &decodedJson)
	if err != nil {
		log.Println(err)
	}
	log.Println(hunterbounter_json.ToStringBeautify(decodedJson))
	return RenderTemplate(c, "panel/vulnerability_report_detail", fiber.Map{
		"Title":       "Vulnerability Report Detail",
		"DecodedData": fullJsonBase64,
	})

}

func OpenVasReportDetailGET(c *fiber.Ctx) error {

	id := c.Params("id")
	var vulnerabilityRecord = model.GetOpenVASVulnerabilityById(id)

	fullJsonBase64 := utils.GetString(vulnerabilityRecord[0]["full_json"])
	decodedData, err := base64.StdEncoding.DecodeString(fullJsonBase64)

	var decodedJson map[string]interface{}
	err = json.Unmarshal(decodedData, &decodedJson)
	if err != nil {
		log.Println(err)
	}
	log.Println(hunterbounter_json.ToStringBeautify(decodedJson))
	return RenderTemplate(c, "panel/vulnerability_report_detail", fiber.Map{
		"Title":       "Vulnerability Report Detail",
		"DecodedData": fullJsonBase64,
	})

}
