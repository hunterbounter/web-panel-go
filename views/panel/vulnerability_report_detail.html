<!DOCTYPE html>
<html lang="zxx" class="js">
{{template "partials/head" .}}
<style>
    /* Arama kutusunu ve butonu sağa hizalamak için */
    .dataTables_filter {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 10px;
    }

    /* Sayfalama kontrollerini sağa hizalamak için */
    .dataTables_paginate {
        display: flex;
        justify-content: flex-end;
        margin-top: 10px;
    }

    .dataTables_paginate .paginate_button {
        margin: 0 5px;
    }
</style>
<body class="nk-body npc-invest npc-invest npc-default has-aside no-touch nk-nio-theme dark-mode">
<div class="nk-app-root">
    <!-- wrap @s -->
    <div class="nk-wrap ">
        <!-- main header @s -->
        {{template "partials/header" .}}
        <!-- main header @e -->
        <!-- content @s -->
        <div class="nk-content nk-content-fluid">
            <div class="container-xl wide-xl">
                <div class="nk-content-inner">
                    <div class="nk-content-body">
                        <div class="nk-block-head nk-block-head-sm">
                            <div class="nk-block-between">
                                <div class="nk-block-head-content">
                                    <h3 class="nk-block-title page-title">Vulnerability Report</h3>
                                    <div class="nk-block-des text-soft">
                                        <p>Summary of the vulnerability report</p>
                                    </div>
                                </div><!-- .nk-block-head-content -->
                                <li class="nk-block-tools-opt">
                                </li>
                                <div class="nk-block-head-content">
                                </div><!-- .nk-block-head-content -->
                            </div><!-- .nk-block-between -->
                        </div><!-- .nk-block-head -->

                        <div class="nk-block">
                            <div class="row g-gs">
                                <div class="card card-bordered card-preview">
                                    <div class="card-inner">
                                        <pre id="jsonData" style="color: white;"></pre>
                                        <div id="container">
                                            <!-- HTML elements will be dynamically added here -->
                                        </div>

                                    </div>
                                </div><!-- .card-preview -->
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
        <!-- content @e -->
        <!-- footer.html @s -->
        {{template "partials/footer" .}}
        <!-- footer.html @e -->
    </div>
    <!-- wrap @e -->
</div>
<!-- app-root @e -->

<!-- JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/js/jquery.dataTables.min.js" integrity="sha512-BkpSL20WETFylMrcirBahHfSnY++H2O1W+UnEEO4yNIl+jI2+zowyoGJpbtk6bx97fBXf++WJHSSK2MV4ghPcg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="{{.SiteURI}}assets/js/bundle.js?ver=3.2.3"></script>
<script src="{{.SiteURI}}assets/js/scripts.js?ver=3.2.3"></script>
<script src="{{.SiteURI}}assets/js/libs/datatable-btns.js?ver=3.2.3"></script>
<script>

    function decodeBase64(encodedStr) {
        try {
            return decodeURIComponent(atob(encodedStr).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
        } catch (e) {
            console.error('Failed to decode base64:', e);
            return 'Error decoding data';
        }
    }

    function beautifyJson(jsonStr) {
        try {
            var jsonObj = JSON.parse(jsonStr);
            return JSON.stringify(jsonObj, null, 2);
        } catch (e) {
            console.error('Failed to parse JSON:', e);
            return 'Error parsing JSON';
        }
    }

    function getQueryParam(param) {
        var urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
    }

    function flattenObject(obj, parent = '', res = {}) {
        for (let key in obj) {
            if (obj.hasOwnProperty(key)) {
                let propName = parent ? `${parent}.${key}` : key;
                if (typeof obj[key] == 'object' && !Array.isArray(obj[key])) {
                    flattenObject(obj[key], propName, res);
                } else {
                    res[propName] = obj[key];
                }
            }
        }
        return res;
    }

    function cleanSpecialCharacters(str) {
        if (typeof str !== 'string') {
            str = String(str);
        }
        return str.replace(/&amp;#39;/g, "'")
            .replace(/&amp;/g, "&")
            .replace(/&lt;/g, "<")
            .replace(/&gt;/g, ">")
            .replace(/&quot;/g, '"')
            .replace(/&apos;/g, "'")
            .replace(/&nbsp;/g, " ")
            .replace(/\s+/g, ' ');
    }

    $(document).ready(function() {
        console.log("Doc On Ready...");
        var encodedData = "{{.DecodedData}}";
        var decodedData = decodeBase64(encodedData);

        var jsonData = JSON.parse(decodedData);

        var debugMode = getQueryParam('debug');

        var flattenedData = flattenObject(jsonData);

        var deletedCols = ["CERTs","Affected Software/OS","QoD","Result ID","Specific Result","Task ID","Task Name",
            "Vulnerability Detection Method","machine_id","report_id","alert","alertRef","confidence","id",
            "machine_id","messageId","other","pluginId","sourceid","wascid","info.author","info.metadata.max-request",
            "info.tags","machine_id","scheme","task_id","template-id","template-path","type",
            "NVT OID","Solution Type"];

        var renameCols = {
            "info.classification.cwe-id": "CWE",
            "info.description": "Description",
            "info.name": "Title",
            "info.references": "Reference",
            "info.severity": "Severity",
            "risk": "Severity",
            "name": "Title",
            "NVT Name": "Title",
            "agent_type": "Agent Type",
            "url": "URL",
            "method": "Method",
            "cweid": "CWE",
            "solution": "Solution",
            "reference": "Reference",
            "curl-command": "Curl Command",
            "host": "Host",
            "info.reference": "Reference",
            "ip": "IP",
            "matched-at": "Matched At",
            "port": "Port",
            "request": "Request",
            "response": "Response",
            "timestamp": "Timestamp",
            "info.remediation": "Solution",

        };

        var orderColsOpenvas = {
            "Title": 1,
            "IP": 2,
            "Port": 3,
            "Severity": 4,
            "Summary": 5,
            "Vulnerability Insight": 6,
            "Impact": 7,
            "CVEs": 8,
            "CVSS": 9,
            "Solution": 10,
            "Solution Type": 11,
            "Timestamp": 12,
            "Agent Type": 13
        };

        var orderColsZap = {
            "Title": 1,
            "URL": 2,
            "Severity": 3,
            "Method": 4,
            "Description": 5,
            "CWE": 6,
            "Solution": 7,
            "Reference": 8
        };

        var orderColsNuclei = {
            "Title": 1,
            "IP": 2,
            "Port": 3,
            "Matched At": 4,
            "URL": 5,
            "Severity": 6,
            "Description": 7,
            "Impact": 8,
            "CWE": 9,
            "Solution": 10,
            "Request": 11,
            "Response": 12,
            "Curl Command": 13,
            "Reference": 14,
            "Timestamp": 15,
            "Agent Type": 16

        };

        function getOrderCols(agentType) {
            console.log("Agent Type: ", agentType);

            if (agentType === "openvas") {
                return orderColsOpenvas;
            } else if (agentType === "nuclei") {
              return orderColsNuclei;

            }else {
                return orderColsZap;
            }
            return null;
        }

        var agentType = flattenedData["agent_type"];
        var orderCols = getOrderCols(agentType);

        // Rename and filter keys
        var filteredData = {};
        for (let key in flattenedData) {
            if (flattenedData.hasOwnProperty(key)) {
                if (deletedCols.includes(key)) {
                    continue;
                }

                let newKey = renameCols[key] || key;
                filteredData[newKey] = cleanSpecialCharacters(flattenedData[key]);
            }
        }

        // Sort the keys based on orderCols, if available
        var orderedKeys;
        if (orderCols) {
            orderedKeys = Object.keys(orderCols).sort((a, b) => orderCols[a] - orderCols[b]);
        } else {
            orderedKeys = Object.keys(filteredData);
        }

        // Generate HTML
        for (let key of orderedKeys) {
            if (filteredData.hasOwnProperty(key)) {
                let value = filteredData[key];

                if (value === null || value === '') {
                    continue;
                }

                // Create the HTML structure
                const colDiv = document.createElement('div');
                colDiv.className = 'col-12';

                const formControlWrapDiv = document.createElement('div');
                formControlWrapDiv.className = 'form-control-wrap';

                const inputGroupDiv = document.createElement('div');
                inputGroupDiv.className = 'input-group mb-3';

                const inputGroupPrependDiv = document.createElement('div');
                inputGroupPrependDiv.className = 'input-group-prepend';

                const span = document.createElement('span');
                span.className = 'input-group-text';
                span.id = 'inputGroup-sizing-default';
                span.textContent = key; // Set the key as the text
                span.style.minWidth = "240px"; // Inline style for min-width

                // Check the word count to decide between input and textarea
                const wordCount = value.split(' ').length;
                let inputElement;

                if (wordCount > 10) {
                    inputElement = document.createElement('textarea');
                    inputElement.className = 'form-control';
                    inputElement.value = value;
                } else {
                    inputElement = document.createElement('input');
                    inputElement.type = 'text';
                    inputElement.className = 'form-control';
                    inputElement.value = value;
                }

                // Append elements
                inputGroupPrependDiv.appendChild(span);
                inputGroupDiv.appendChild(inputGroupPrependDiv);
                inputGroupDiv.appendChild(inputElement);
                formControlWrapDiv.appendChild(inputGroupDiv);
                colDiv.appendChild(formControlWrapDiv);

                // Append the created HTML to the container
                document.getElementById('container').appendChild(colDiv);
            }
        }

        if (getQueryParam('debug')) {
            var beautifiedData = beautifyJson(decodedData);
            document.getElementById("jsonData").textContent = beautifiedData;
        }
    });
</script>

</body>
</html>
